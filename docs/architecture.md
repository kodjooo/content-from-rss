Архитектура AI News Auto Writer MVP
===================================

1. Общая структура
------------------
- `app.config` — загрузка конфигурации из `.env`, валидация переменных окружения, предоставление объектной модели настроек (RSS, OpenAI, Pexels, FreeImageHost, Google Sheets, планировщик).
- `app.models` — дата-классы для обмена данными между модулями: `RawFeedEntry`, `NewsItem`, `RankedNews`, `GeneratedPost`, `ImageAsset`, `PublicationRecord`.
- `app.rss` — получение RSS-лент с помощью `feedparser`, фильтрация по ключевым словам, нормализация полей и дедупликация.
- `app.scoring` — обращение к OpenAI Chat/Completion API для оценки релевантности материала; реализует политику повторных попыток и кэширование по URL.
- `app.post_generator` — формирование системного/пользовательского промтов и получение итогового текста поста (1500–3000 символов, 3–4 хэштега) с валидацией формата и повторами.
- `app.image_pipeline` — многошаговый поиск изображения: данные RSS → Pexels API → генерация через OpenAI Images; загрузка результата на FreeImageHost.
- `app.sheets` — работа с Google Sheets через `gspread`, авторизация по service account, запись строк формата MVP.
- `app.orchestrator` — управление основным сценарием: сбор новостей → оценка → генерация поста → подбор изображения → запись в Google Sheets; содержит логику ретраев и метрик.
- `app.scheduler` — планировщик запусков (07:00 и 19:00 Europe/Moscow) на основе `APScheduler`, регистрирует задачу `PipelineRunner`.
- `app.logging_utils` — настройка единообразного форматирования логов и интеграции с планировщиком.
- `scripts.setup_env` — CLI для генерации `.env` из `.env.example`, автогенерации секретов и проверки обязательных переменных.

2. Взаимодействия модулей
-------------------------
1. `scheduler` инициирует запуск `PipelineRunner` в заданные окна времени.
2. `PipelineRunner` (из `orchestrator`) получает конфигурацию через `config.load_settings()`.
3. `rss.RSSCollector` собирает записи и возвращает список `NewsItem`.
4. `scoring.RelevanceScorer` выставляет оценку и фильтрует материалы с рейтингом < 7.
5. Для каждой релевантной новости `post_generator.PostComposer` создает финальный текст.
6. `image_pipeline.ImageSelector` возвращает `ImageAsset` с финальным URL.
7. `sheets.GoogleSheetsWriter` сериализует `PublicationRecord` и отправляет строку в Google Sheets.

3. Переменные окружения
-----------------------
- `SHEET_ID` — идентификатор Google Sheets.
- `GOOGLE_SERVICE_ACCOUNT_JSON` — путь к JSON с данными сервисного аккаунта.
- `SHEET_WORKSHEET` — название вкладки, куда записываются строки (по умолчанию Sheet1).
- `PEXELS_API_KEY` — токен доступа к Pexels API.
- `FREEIMAGEHOST_API_KEY` — ключ для загрузки изображений.
- `OPENAI_API_KEY` — ключ OpenAI.
- `OPENAI_MODEL_RANK` — модель для оценки релевантности (по умолчанию `gpt-4o-mini`).
- `OPENAI_MODEL_POST` — модель для генерации поста (по умолчанию `gpt-4o-mini`).
- `OPENAI_IMAGE_MODEL` — модель для генерации изображений (по умолчанию `gpt-image-1`).
- `SCHEDULER_TIMEZONE` — таймзона планировщика, по умолчанию `Europe/Moscow`.
- `RSS_SOURCES` — список RSS-URL через запятую (значение по умолчанию в коде).
- `KEYWORDS` — ключевые слова для фильтрации (значение по умолчанию в коде).
- `SIMILARITY_THRESHOLD` — предел схожести для дедупликации (0–1, дефолт 0.85).
- `FREEIMAGEHOST_API_ENDPOINT` — URL API загрузки.
- `FREEIMAGEHOST_API_TIMEOUT` — таймаут в секундах.
- `PEXELS_API_TIMEOUT` — таймаут запросов к Pexels.
- `PIPELINE_MAX_ITEMS` — ограничение числа новостей за цикл.
- `CACHE_DIR` — каталог для временных файлов и кэша.

4. Потоки данных и контроль качества
------------------------------------
- На каждом шаге используется структурированное логирование (`logging_utils`).
- Критические блоки (`scoring`, `post_generator`, `image_pipeline`, `sheets`) обернуты ретраями и перегрузками, ошибки фиксируются, но не блокируют остальные записи.
- Юнит-тесты используют фикстуры и моки внешних API (через `pytest` + `responses`/`requests-mock`).
- Интеграционный тест запускает `PipelineRunner` с полностью замоканными клиентами.

5. Docker и развертывание
-------------------------
- `Dockerfile` собирает приложение на Python 3.11, устанавливает зависимости из `requirements.txt`.
- `docker-compose.yml` (будет добавлен) запускает сервис с монтированием конфигурации, обеспечивает переменные окружения и том для кэша.
- Планировщик работает внутри контейнера, процесс `app.main` удерживает контейнер активным.
- Логи выводятся в stdout/stderr, что упрощает интеграцию с внешним мониторингом.

6. Безопасность и секреты
-------------------------
- Секреты хранятся только в `.env` (не коммитится).
- `scripts.setup_env` может сгенерировать `.env`, наполнив уникальными секретами по шаблону и оставив пустые места для API-ключей.
- Сервисный аккаунт Google хранится отдельно и путь до него указывается через переменную окружения.

7. Чек-лист приемки
-------------------
- Проверить успешную генерацию `.env` командой `python scripts/setup_env.py --force`.
- Запустить `python -m app.main --mode run-once` с тестовыми ключами и убедиться, что строка попадает в таблицу (можно использовать моковый лист).
- Проверить корректность загрузки изображения на FreeImageHost (возврат финального URL).
- Убедиться, что планировщик в контейнере регистрирует задания на 07:00 и 19:00 (лог `Запланирован запуск пайплайна`).
- Запустить тесты `pytest` вне контейнера и в Docker (`docker compose run --rm news-writer python -m pytest`).
